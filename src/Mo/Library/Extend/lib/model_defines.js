function DataTable(b,a){if(this.constructor!==DataTable){return new DataTable(b,a)}this.LIST__=[];this.index=-1;this.pagesize=a||-1;this.recordcount=0;this.currentpage=1;this.GetEnumerator=function(){return new Enumerator(this.LIST__)};if(b==null){return}if(typeof b=="object"&&b.constructor==Array){this.fromArray(b,this.pagesize)}else{if(b!==undefined){this.__AddDataSet__(b,a)}}}DataTable.prototype.dispose=function(){while(this.LIST__.length>0){F.dispose(this.LIST__.pop())}};DataTable.prototype.fromArray=function(b,a){this.LIST__=b;this.pagesize=a||-1;this.recordcount=b.length;return this};DataTable.prototype.getState=function(a){if(a==undefined){a="yyyy-MM-dd HH:mm:ss"}var b="{";b+='"pagesize":'+this.pagesize+",";b+='"recordcount":'+this.recordcount+",";b+='"currentpage":'+this.currentpage+",";b+='"LIST__":'+this.getjson(a)+"}";return b};DataTable.prototype.fromState=function(a){this.LIST__=a.LIST__;this.pagesize=a.pagesize;this.recordcount=a.recordcount;this.currentpage=a.currentpage};DataTable.prototype.add=function(a){if(typeof a=="string"){a=F.json(a);if(a==null){return}}if(typeof a=="object"&&a.constructor==DataTableRow){a=a.data()}this.LIST__.push(a||new Object());this.recordcount++;return this.LIST__[this.LIST__.length-1]};DataTable.prototype.__AddDataSet__=function(b,f){if(b==null){ExceptionManager.put(new Exception(0,"DataTable.__AddDataSet__(rs,pagesize)","Recordset is null"));return}if(b.state==0){ExceptionManager.put(new Exception(0,"DataTable.__AddDataSet__(rs,pagesize)","Recordset's state is 'closed'."));return}try{if(f==undefined){f=-1}var g=b.AbsolutePosition;var a=0;while(!b.eof&&(a<f||f==-1)){a++;var e=new Object();for(var d=0;d<b.fields.count;d++){e[b.fields(d).Name]=b.fields(d).value}this.LIST__.push(e);b.MoveNext()}try{b.AbsolutePosition=g}catch(c){}}catch(c){ExceptionManager.put(new Exception(c.number,"DataTable.__AddDataSet__(rs,pagesize)",c.description))}};DataTable.prototype.reset=function(){this.index=-1};DataTable.prototype.count=function(){return this["LIST__"].length};DataTable.prototype.eof=function(){return this["LIST__"].length==0||this.index+1>=this["LIST__"].length};DataTable.prototype.read=function(a){a=a||"";this.index++;if(a==""||a==undefined){return this["LIST__"][this.index]}else{return this["LIST__"][this.index][a]}};DataTable.prototype.each=function(b){if(typeof b=="string"){b=(function(c){return function(d){F.echo(F.format(c,d))}})(b)}if(typeof b!="function"){return}for(var a=0;a<this["LIST__"].length;a++){b.call(this,this["LIST__"][a],a)}};DataTable.prototype.assign=function(a){Mo.assign(a,this);return this};DataTable.prototype.getjson=function(j,k){var g="[",f=false,h="";if(typeof j=="function"){k=j;j=undefined}if(typeof j=="object"){if(j.hasOwnProperty("format")){h=j.format;if(typeof h=="object"){var d="";for(var e in h){if(!h.hasOwnProperty(e)){continue}d+='"'+e+'":'+h[e]+","}if(d!=""&&d.substr(d.length-1)==","){d=d.substr(0,d.length-1)}h=d}}k=j.callback;j=j.dateformat}f=(typeof k=="function");var g="[",f=(typeof k=="function");while(!this.eof()){var a=this.read();g+="{";if(h!=""){g+=F.format(h,a)}else{for(var e in a){if(e=="ROWID_"||!a.hasOwnProperty(e)){continue}if(f&&k.call(a,e)===false){continue}var b=a[e];var c=typeof b;g+='"'+e+'":';if(c=="number"){g+=b+","}else{if(c=="date"){if(j===undefined){g+='"'+(new Date(b)).getTime()+'",'}else{g+='"'+F.formatdate(b,j)+'",'}}else{if(c=="string"){g+=JSON.stringify(b)+","}else{if(c=="unknown"){g+='"unknown",'}else{if(!isNaN(b)){g+=b+","}else{g+='"'+b+'",'}}}}}}}if(g.substr(g.length-1,1)==","){g=g.substr(0,g.length-1)}g+="},"}if(g.substr(g.length-1,1)==","){g=g.substr(0,g.length-1)}g+="]";return g};function DataTableRow(){if(this.constructor!==DataTableRow){return Function.Create(arguments.length).apply(DataTableRow,arguments)}this.table={};this.pk="";var a=arguments;if(a.length%2==0){for(var b=0;b<a.length-1;b+=2){this.set(a[b],a[b+1])}}else{if(typeof a=="object"){this.fromObject(a);return}}}DataTableRow.prototype.fromPost=function(a){return this.fromObject(F.post(),a||"")};DataTableRow.prototype.fromObject=function(c,b){b=b||"";for(var a in c){if(!c.hasOwnProperty(a)){continue}if(a.length>2&&a.substr(a.length-2)==":i"){continue}if(a.toLowerCase()!=b.toLowerCase()){this.set(a,c[a])}else{this.pk=c[a]}}return this};DataTableRow.prototype.set=function(a,c,b){b=b||"string";this.table[a]={value:c,type:b};return this};DataTableRow.prototype.get=function(a){if(this.table[a]!==undefined){return this.table[a].value}return""};DataTableRow.prototype.remove=function(){for(var a=0;a<arguments.length;a++){delete this.table[arguments[a]]}return this};DataTableRow.prototype.clear=function(){this.table={};return this};DataTableRow.prototype.assign=function(a){Mo.assign(a,this.data());return this};DataTableRow.prototype.data=function(a){var c={};for(var b in this.table){if(!this.table.hasOwnProperty(b)){continue}c[b]=this.table[b].value}return c};var ModelHelper={Enums:{ParameterDirection:{INPUT:1,INPUTOUTPUT:3,OUTPUT:2,RETURNVALUE:4},DataType:{ARRAY:8192,DBTYPE_I8:20,DBTYPE_BYTES:128,DBTYPE_BOOL:11,DBTYPE_BSTR:8,DBTYPE_HCHAPTER:136,DBTYPE_STR:129,DBTYPE_CY:6,DBTYPE_DATE:7,DBTYPE_DBDATE:133,DBTYPE_DBTIME:134,DBTYPE_DBTIMESTAMP:135,DBTYPE_DECIMAL:14,DBTYPE_R8:5,DBTYPE_EMPTY:0,DBTYPE_ERROR:10,DBTYPE_FILETIME:64,DBTYPE_GUID:72,DBTYPE_IDISPATCH:9,DBTYPE_I4:3,DBTYPE_IUNKNOWN:13,LONGVARBINARY:205,LONGVARCHAR:201,LONGVARWCHAR:203,DBTYPE_NUMERIC:131,DBTYPE_PROP_VARIANT:138,DBTYPE_R4:4,DBTYPE_I2:2,DBTYPE_I1:16,DBTYPE_UI8:21,DBTYPE_UI4:19,DBTYPE_UI2:18,DBTYPE_UI1:17,DBTYPE_UDT:132,VARBINARY:204,VARCHAR:200,DBTYPE_VARIANT:12,VARNUMERIC:139,VARWCHAR:202,DBTYPE_WSTR:130},CommandType:{UNSPECIFIED:-1,TEXT:1,TABLE:2,STOREDPROC:4,UNKNOWN:8,FILE:256,TABLEDIRECT:512}},GetConnectionString:function(){var c="";if(this["DB_Type"]=="OTHER"||(this.hasOwnProperty("DB_Connectionstring")&&this["DB_Connectionstring"]!="")){c=F.format(this["DB_Connectionstring"],this["DB_Server"],this["DB_Username"],this["DB_Password"],this["DB_Name"],F.mappath(this["DB_Path"]))}else{if(this["DB_Type"]=="ACCESS"){c="provider=microsoft.jet.oledb.4.0; data source="+F.mappath(this["DB_Path"])}else{if(this["DB_Type"]=="MSSQL"){c=F.format("provider=sqloledb.1;Persist Security Info=false;data source={0};User ID={1};pwd={2};Initial Catalog={3}",this["DB_Server"],this["DB_Username"],this["DB_Password"],this["DB_Name"])}else{if(this["DB_Type"]=="SQLITE"){c="DRIVER={SQLite3 ODBC Driver};Database="+F.mappath(this["DB_Path"])}else{if(this["DB_Type"]=="MYSQL"){var b=this["DB_Server"],d=b,a=3306;if(d.indexOf(",")>0){d=b.substr(0,b.indexOf(","));a=b.substr(b.indexOf(",")+1)}c=F.format("DRIVER={mysql odbc "+(this["DB_Version"]||"3.51")+" driver};SERVER={0};PORT={4};USER={1};PASSWORD={2}",d,this["DB_Username"],this["DB_Password"],this["DB_Name"],a)}}}}}return c},GetSqls:function(){var f="",d="",g="",a="",e="",b="",c="";if(this.strwhere!=""){f=" where "+this.strwhere+"";if(this.strpage>1&&this.strlimit!=-1){g=" and ("+this.strwhere+")"}}if(this.strgroupby!=""){a=" group by "+this.strgroupby}if(this.strjoin!=""){e=" "+this.strjoin+" "}if(this.strcname!=""){c=" "+this.strcname+" "}if(this.strorderby!=""){d=" order by "+this.strorderby}if(this.pagekeyorder==""||this.strlimit==-1){this.sql="select "+this.fields+" from "+this.joinlevel+this.table+c+e+f+a+d;if(this.base.cfg.DB_Type=="MYSQL"){this.countsql="select count("+(this.strcname==""?this.table:this.strcname)+"."+this.pk+") from "+this.joinlevel+this.table+c+e+f+a}}else{this.countsql="select count("+(this.strcname==""?this.table:this.strcname)+"."+this.pk+") from "+this.joinlevel+this.table+c+e+f+a;this.sql=ModelHelper.GetSqlByTypes.apply(this,[c,e,b,f,a,d])}},GetSqlByTypes:function(d,f,b,e,a,c){if(this.base.cfg.DB_Type=="MSSQL"){return ModelHelper.GetSqlsForMSSQL.apply(this,arguments)}if(this.base.cfg.DB_Type=="MYSQL"){return ModelHelper.GetSqlsForMysql.apply(this,arguments)}if(this.base.cfg.DB_Type=="SQLITE"){return ModelHelper.GetSqlsForMysql.apply(this,arguments)}return ModelHelper.GetSqlsForAccess.apply(this,arguments)},GetSqlsForAccess:function(e,a,g,f,j,b){var k;if(this.isonlypkorder&&this.ballowOnlyPKOrder){if(this.strpage>1){var i="<",h="min";if(this.onlypkorder.toLowerCase()=="asc"){i=">";h="max"}f+=" "+(f!=""?"and":"where")+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+i+" (select "+h+"("+this.pagekey+") from (select top "+this.strlimit*(this.strpage-1)+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" from "+this.joinlevel+this.table+e+a+f+j+b+") as mo_p_tmp)"}k="select top "+this.strlimit+" "+this.fields+" from "+this.joinlevel+this.table+e+a+f+j+b}else{if(this.strpage>1){f+=" "+(f!=""?"and":"where")+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" not in(select top "+this.strlimit*(this.strpage-1)+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" from "+this.joinlevel+this.table+e+a+f+j+b+")"}k="select top "+this.strlimit+" "+this.fields+" from "+this.joinlevel+this.table+e+a+f+j+b}return k},GetSqlsForMSSQL:function(e,a,g,f,j,b){if(this.base.cfg.DB_Version==2012){return"select "+this.fields+" from "+this.joinlevel+this.table+e+a+f+j+b+" OFFSET "+(this.strlimit*(this.strpage-1)+1)+" ROWS FETCH NEXT "+this.strlimit+" ROWS ONLY"}else{if(this.base.cfg.DB_Version>=2005){return"select * from (select "+this.fields+",ROW_NUMBER() OVER ("+b+") AS ROWID_ from "+this.joinlevel+this.table+e+a+f+j+") AS tmp_table_1 where ROWID_ BETWEEN "+(this.strlimit*(this.strpage-1)+1)+" and "+(this.strlimit*this.strpage)}}var k;if(this.isonlypkorder&&this.ballowOnlyPKOrder){if(this.strpage>1){var i="<",h="min";if(this.onlypkorder.toLowerCase()=="asc"){i=">";h="max"}f+=" "+(f!=""?"and":"where")+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+i+" (select "+h+"("+this.pagekey+") from (select top "+this.strlimit*(this.strpage-1)+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" from "+this.joinlevel+this.table+e+a+f+j+b+") as mo_p_tmp)"}k="select top "+this.strlimit+" "+this.fields+" from "+this.joinlevel+this.table+e+a+f+j+b}else{if(this.strpage>1){f+=" "+(f!=""?"and":"where")+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" not in(select top "+this.strlimit*(this.strpage-1)+" "+(this.strcname==""?this.table:this.strcname)+"."+this.pagekey+" from "+this.joinlevel+this.table+e+a+f+j+b+")"}k="select top "+this.strlimit+" "+this.fields+" from "+this.joinlevel+this.table+e+a+f+j+b}return k},GetSqlsForMysql:function(e,g,b,f,a,d){if(this.isonlypkorder&&this.ballowOnlyPKOrder){if(this.strpage>1){var h="<=";if(this.onlypkorder.toLowerCase()=="asc"){h=">="}sql="select "+this.fields+" from "+this.joinlevel+this.table+e+g+f+(f!=""?" and ":" where ")+this.table+"."+this.pk+h+"(select "+(this.strcname==""?this.table:this.strcname)+"."+this.pk+" from "+this.joinlevel+this.table+g+f+a+d+" limit "+this.strlimit*(this.strpage-1)+",1)"+a+d+" limit "+this.strlimit+""}else{sql="select "+this.fields+" from "+this.joinlevel+this.table+e+g+f+a+d+" limit 0,"+this.strlimit+""}}else{sql="select "+this.fields+" from "+this.joinlevel+this.table+e+g+f+a+d+" limit "+this.strlimit*(this.strpage-1)+","+this.strlimit+""}return sql},GetTables:function(){var conn=this.base;var table_named_field_name="TABLE_NAME";var rs=null;if(this.cfg.DB_Type=="ACCESS"){rs=conn.openSchema(20,VBS.eval('Array(Empty,Empty,Empty,"Table")'))}if(this.cfg.DB_Type=="MSSQL"){rs=conn.openSchema(20,VBS.eval('Array("'+this.cfg.DB_Name+'",Empty,Empty,"Table")'))}if(this.cfg.DB_Type=="SQLITE"){rs=conn.execute("select * from sqlite_master where type = 'table'");table_named_field_name="name"}if(this.cfg.DB_Type=="MYSQL"){rs=conn.execute("show tables");table_named_field_name="Tables_in_public"}if(rs==null){return null}var obj={},i=0;while(!rs.eof){var tablename=rs(table_named_field_name).Value;obj[tablename]=ModelHelper.GetColumns.call(this,tablename);rs.movenext()}return obj},GetColumns:function(tablename){var conn=this.base;var rs=null;if(this.cfg.DB_Type=="ACCESS"){rs=conn.openSchema(4,VBS.eval('Array(Empty,Empty,"'+tablename+'")'))}if(this.cfg.DB_Type=="MSSQL"){rs=conn.openSchema(4,VBS.eval('Array("'+this.cfg.DB_Name+'","'+(this.cfg.DB_Owner||"dbo")+'","'+tablename+'")'))}if(this.cfg.DB_Type=="SQLITE"){rs=conn.execute("PRAGMA table_info("+tablename+")")}if(this.cfg.DB_Type=="MYSQL"){rs=conn.execute("show columns from `"+tablename+"`")}if(rs==null){return null}var obj={},i=0;while(!rs.eof){if(this.cfg.DB_Type=="SQLITE"){obj[rs("name").Value]={DATA_TYPE:rs.fields("type").Value,IS_NULLABLE:rs.fields("notnull").Value==0,IS_PK:rs.fields("pk").Value==1,COLUMN_DEFAULT:rs.fields("dflt_value").Value}}else{if(this.cfg.DB_Type=="MYSQL"){obj[rs("Field").Value]={DATA_TYPE:rs.fields("Type").Value,IS_NULLABLE:rs.fields("Null").Value=="YES",IS_PK:rs.fields("Key").Value=="PRI",COLUMN_DEFAULT:rs.fields("Default").Value}}else{var cname=rs("COLUMN_NAME").Value;obj[cname]={DATA_TYPE:rs.fields("DATA_TYPE").Value,COLUMN_FLAGS:rs.fields("COLUMN_FLAGS").Value,IS_NULLABLE:rs.fields("IS_NULLABLE").Value,COLUMN_DEFAULT:rs.fields("COLUMN_DEFAULT").Value,NUMERIC_PRECISION:rs.fields("NUMERIC_PRECISION").Value,NUMERIC_SCALE:rs.fields("NUMERIC_SCALE").Value,CHARACTER_MAXIMUM_LENGTH:rs.fields("CHARACTER_MAXIMUM_LENGTH").Value};if(obj[cname].DATA_TYPE==130){if(obj[cname].COLUMN_FLAGS>>7==1){obj[cname].CHARACTER_MAXIMUM_LENGTH=1024000}}}}rs.movenext()}return obj}};function ModelCMDManager(c,a,b){this.cmd=c||"";this.model=a||null;this.parms_={};this.cmdobj=F.activex("ADODB.Command");this.cmdobj.ActiveConnection=a.getConnection();this.cmdobj.CommandType=b||4;this.cmdobj.Prepared=true;this.withQuery=true;this.parmsGet=false;this.totalRecordsParm="";this.parms_count=0;this.dataset=null;this.affectedRows=-1}ModelCMDManager.New=function(c,a,b){return new ModelCMDManager(c,a,b)};ModelCMDManager.prototype.addParm=function(a,b,c){this.parms_[a]=this.cmdobj.CreateParameter(a);this.parms_[a].Value=b;this.parms_[a].Direction=c||1;return this.parms_[a]};ModelCMDManager.prototype.addInput=function(a,d,c,b){this.parms_[a]=this.cmdobj.CreateParameter(a,c,ModelHelper.Enums.ParameterDirection.INPUT,b,d);return this.parms_[a]};ModelCMDManager.prototype.add_parm_input=function(c,b,a){return this.addInput("@PARM"+ ++this.parms_count,c,b,a)};ModelCMDManager.prototype.addInputInt=function(a,b){return this.addInput(a,b,ModelHelper.Enums.DataType.DBTYPE_I4,4)};ModelCMDManager.prototype.add_parm_input_int=function(a){return this.addInputInt("@PARM"+ ++this.parms_count,a)};ModelCMDManager.prototype.addInputBigInt=function(a,b){return this.addInput(a,b,ModelHelper.Enums.DataType.DBTYPE_I8,8)};ModelCMDManager.prototype.add_parm_input_bigint=function(a){return this.addInputBigInt("@PARM"+ ++this.parms_count,a)};ModelCMDManager.prototype.addInputVarchar=function(a,c,b){return this.addInput(a,c,ModelHelper.Enums.DataType.VARCHAR,b||50)};ModelCMDManager.prototype.add_parm_input_varchar=function(b,a){return this.addInputVarchar("@PARM"+ ++this.parms_count,b,a)};ModelCMDManager.prototype.addOutput=function(a,c,b){this.parms_[a]=this.cmdobj.CreateParameter(a,c,ModelHelper.Enums.ParameterDirection.OUTPUT,b);return this.parms_[a]};ModelCMDManager.prototype.add_parm_output=function(b,a,d){var c="@PARM"+ ++this.parms_count;if(a===true||d===true){if(a===true){a=undefined}this.totalRecordsParm=c}return this.addOutput(c,b,a)};ModelCMDManager.prototype.addReturn=function(a,c,b){this.parms_[a]=this.cmdobj.CreateParameter(a,c,ModelHelper.Enums.ParameterDirection.RETURNVALUE,b);return this.parms_[a]};ModelCMDManager.prototype.add_parm_return=function(b,a){return this.addReturn("@RETURN",b,a)};ModelCMDManager.prototype.getparm=function(a){if(!this.parmsGet){for(var b in this.parms_){if(!this.parms_.hasOwnProperty(b)){continue}if(this.parms_[b].Direction>1){this.parms_[b].value=this.cmdobj(b).value}}this.parmsGet=true}if(typeof a=="number"){a="@PARM"+a}if(!this.parms_.hasOwnProperty(a)){return null}return this.parms_[a]};ModelCMDManager.prototype.get_parm_return=function(){return this.getparm("@RETURN")};ModelCMDManager.prototype.execute=function(a){this.withQuery=a===true;this.model.exec(this);return this.model};ModelCMDManager.prototype.assign=function(a,b){return this.model.assign(a,b)};ModelCMDManager.prototype.exec=function(){this.cmdobj.CommandText=this.cmd;for(var a in this.parms_){if(!this.parms_.hasOwnProperty(a)){continue}this.cmdobj.Parameters.Append(this.parms_[a])}Model__.RecordsAffectedCmd_(this);return this.dataset};ModelCMDManager.prototype.next=function(a){if(this.dataset){this.dataset=this.dataset.NextRecordset();if(this.dataset){return new DataTable(this.dataset,a||-1)}}};ModelCMDManager.prototype.fetch=function(c){if(this.dataset){var b=new DataTable(this.dataset,c||-1);try{this.dataset.close()}catch(a){}return b}};exports.Helper=ModelHelper;exports.CMDManager=ModelCMDManager;exports.DataTable=DataTable;exports.DataTableRow=DataTableRow;